
> restaurant-guide-belarus-backend@1.0.0 test
> NODE_ENV=test node --experimental-vm-modules node_modules/jest/bin/jest.js

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/integration/media.test.js
  ● Test suite failed to run

    SyntaxError: The requested module '../utils/database.js' does not provide an export named 'getPool'

      at Runtime.linkAndEvaluateModule (node_modules/jest-runtime/build/index.js:684:5)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

(node:3702) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL src/tests/integration/establishments.test.js
  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Basic Creation › should create new establishment in draft status

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Basic Creation › should create establishment with all fields

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Basic Creation › should create establishment with minimal required fields

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Basic Creation › should reject creation without authentication

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Basic Creation › should reject creation by regular user (not partner)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should accept Минск

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should accept Гродно

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should accept Брест

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should accept Гомель

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should accept Витебск, Могилев, Бобруйск

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should reject invalid city (Москва)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Belarus City Validation › should reject invalid city (Kiev)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should accept valid Minsk coordinates

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should accept coordinates at Belarus boundaries

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should reject coordinates outside Belarus (Moscow)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should reject coordinates north of Belarus

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should reject coordinates south of Belarus

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should reject coordinates west of Belarus

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Geographic Coordinates Validation › should reject coordinates east of Belarus

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Categories Validation › should accept 1 category

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Categories Validation › should accept 2 categories

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Categories Validation › should reject 0 categories

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Categories Validation › should reject 3 categories (max is 2)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Categories Validation › should accept all valid category types

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Categories Validation › should reject invalid category

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should accept 1 cuisine

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should accept 2 cuisines

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should accept 3 cuisines (maximum)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should reject 0 cuisines

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should reject 4 cuisines (max is 3)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should accept all valid cuisine types

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Cuisines Validation › should reject invalid cuisine

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Required Fields Validation › should reject missing name

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Required Fields Validation › should reject missing description

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Required Fields Validation › should reject missing city

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Required Fields Validation › should reject missing coordinates

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Required Fields Validation › should reject missing categories

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Create Establishment › POST /api/v1/partner/establishments - Required Fields Validation › should reject missing cuisines

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments - List Own Establishments › should list all partner establishments

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments - List Own Establishments › should only show own establishments (ownership filter)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments - List Own Establishments › should support pagination

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments - List Own Establishments › should filter by status

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments/:id - Get Single Establishment › should get establishment details

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments/:id - Get Single Establishment › should reject getting other partner establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments/:id - Get Single Establishment › should reject non-existent establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - List & Read Operations › GET /api/v1/partner/establishments/:id - Get Single Establishment › should reject invalid UUID format

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Update Operations › should update establishment name

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Update Operations › should update establishment description

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Update Operations › should update coordinates

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Update Operations › should update categories and cuisines

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Update Operations › should reject updates by non-owner

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Status Workflow › should submit draft for moderation (draft → pending)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Status Workflow › should reject submitting already pending establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Status Workflow › should reset to pending on major changes to active establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)

  ● Establishments System - Status Workflow › should track status history

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:34:20)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/establishments.test.js:51:3)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/integration/reviews.test.js
  ● Reviews System - Create Review › should create review with valid data

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should accept ratings 1-5

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject rating 0

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject rating 6

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject non-integer rating

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject missing content

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject empty content

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject review without authentication

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should reject review for non-existent establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Create Review › should handle Russian/Belarusian text in content

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - One Review Per User Per Establishment › should allow first review for establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - One Review Per User Per Establishment › should reject second review from same user for same establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - One Review Per User Per Establishment › should allow different users to review same establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - One Review Per User Per Establishment › should allow same user to review different establishments

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Establishment Metrics Update › should initialize metrics on first review

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Establishment Metrics Update › should update average rating correctly (2 reviews)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Establishment Metrics Update › should increment review count correctly

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Read Reviews › should get review by ID (public)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Read Reviews › should list reviews for establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Read Reviews › should paginate reviews

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Read Reviews › should sort reviews by newest

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Read Reviews › should sort reviews by highest rating

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Update Review › should update own review

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Update Review › should reject updating other user review

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Update Review › should recalculate metrics after update

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Delete Review › should soft delete own review

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Delete Review › should not show deleted review in list

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Delete Review › should reject deleting other user review

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Delete Review › should update metrics after deletion

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Daily Quota › should allow 10 reviews in one day

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Daily Quota › should reject 11th review (quota exceeded)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Daily Quota › should reset quota at midnight

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Daily Quota › should track quota per user independently

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Partner Responses › should allow partner to respond to review on their establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Partner Responses › should reject partner responding to review on other establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)

  ● Reviews System - Partner Responses › should reject regular user adding partner response

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:44:16)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/reviews.test.js:91:3)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/unit/authService.test.js
  ● Test suite failed to run

    Cannot find module '../config/database.js' from 'src/tests/unit/authService.test.js'

      14 |
      15 | // Mock dependencies BEFORE importing service
    > 16 | jest.unstable_mockModule('../config/database.js', () => ({
         |      ^
      17 |   pool: {
      18 |     query: jest.fn(),
      19 |   },

      at Resolver._throwModNotFoundError (node_modules/jest-resolve/build/index.js:863:11)
      at src/tests/unit/authService.test.js:16:6

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/unit/establishmentService.test.js
  establishmentService
    createEstablishment
      ✓ should create establishment with valid data (4 ms)
      ✕ should throw error for invalid city (9 ms)
      ✓ should accept all valid Belarus cities (2 ms)
      ✕ should throw error for invalid categories length (2 ms)
      ✕ should throw error for invalid category values (2 ms)
      ✓ should accept 1-2 valid categories (1 ms)
      ✕ should throw error for invalid cuisines length (1 ms)
      ✕ should throw error for invalid cuisine values (1 ms)
      ✓ should accept 1-3 valid cuisines (2 ms)
      ✕ should validate latitude within Belarus bounds (1 ms)
      ✕ should validate longitude within Belarus bounds (1 ms)
      ✓ should accept valid Belarus coordinates (6 ms)
      ✕ should throw error for duplicate establishment name (2 ms)
      ✕ should handle database unique constraint violation (1 ms)
      ✕ should handle database check constraint violation (2 ms)
    getPartnerEstablishments
      ✓ should fetch establishments with default pagination (2 ms)
      ✓ should handle custom pagination parameters (1 ms)
      ✓ should enforce maximum limit of 50 (1 ms)
      ✓ should filter by status when provided (1 ms)
      ✕ should handle database errors gracefully (1 ms)
    getEstablishmentById
      ✓ should fetch establishment when partner owns it (1 ms)
      ✕ should throw error when partner does not own establishment (2 ms)
      ✕ should throw error when establishment not found (2 ms)
      ✕ should handle database errors (2 ms)
    updateEstablishment
      ✓ should update establishment when partner owns it (1 ms)
      ✕ should throw error when partner does not own establishment (1 ms)

  ● establishmentService › createEstablishment › should throw error for invalid city

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_CITY",
        "statusCode": 422,
      }

      114 |
      115 |       await expect(createEstablishment(partnerId, invalidData)).rejects.toThrow(AppError);
    > 116 |       await expect(createEstablishment(partnerId, invalidData)).rejects.toMatchObject({
          |                                                                         ^
      117 |         statusCode: 422,
      118 |         code: 'INVALID_CITY',
      119 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:116:73)

  ● establishmentService › createEstablishment › should throw error for invalid categories length

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_CATEGORIES_LENGTH",
        "statusCode": 422,
      }

      137 |       await expect(
      138 |         createEstablishment(partnerId, { ...validEstablishmentData, categories: [] })
    > 139 |       ).rejects.toMatchObject({
          |                 ^
      140 |         statusCode: 422,
      141 |         code: 'INVALID_CATEGORIES_LENGTH',
      142 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:139:17)

  ● establishmentService › createEstablishment › should throw error for invalid category values

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_CATEGORY_VALUE",
        "statusCode": 422,
      }

      160 |       };
      161 |
    > 162 |       await expect(createEstablishment(partnerId, invalidData)).rejects.toMatchObject({
          |                                                                         ^
      163 |         statusCode: 422,
      164 |         code: 'INVALID_CATEGORY_VALUE',
      165 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:162:73)

  ● establishmentService › createEstablishment › should throw error for invalid cuisines length

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_CUISINES_LENGTH",
        "statusCode": 422,
      }

      191 |       await expect(
      192 |         createEstablishment(partnerId, { ...validEstablishmentData, cuisines: [] })
    > 193 |       ).rejects.toMatchObject({
          |                 ^
      194 |         statusCode: 422,
      195 |         code: 'INVALID_CUISINES_LENGTH',
      196 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:193:17)

  ● establishmentService › createEstablishment › should throw error for invalid cuisine values

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_CUISINE_VALUE",
        "statusCode": 422,
      }

      214 |       };
      215 |
    > 216 |       await expect(createEstablishment(partnerId, invalidData)).rejects.toMatchObject({
          |                                                                         ^
      217 |         statusCode: 422,
      218 |         code: 'INVALID_CUISINE_VALUE',
      219 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:216:73)

  ● establishmentService › createEstablishment › should validate latitude within Belarus bounds

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_LATITUDE",
        "statusCode": 422,
      }

      248 |           latitude: 50.0, // Below 51.0
      249 |         })
    > 250 |       ).rejects.toMatchObject({
          |                 ^
      251 |         statusCode: 422,
      252 |         code: 'INVALID_LATITUDE',
      253 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:250:17)

  ● establishmentService › createEstablishment › should validate longitude within Belarus bounds

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_LONGITUDE",
        "statusCode": 422,
      }

      272 |           longitude: 22.0, // Below 23.0
      273 |         })
    > 274 |       ).rejects.toMatchObject({
          |                 ^
      275 |         statusCode: 422,
      276 |         code: 'INVALID_LONGITUDE',
      277 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:274:17)

  ● establishmentService › createEstablishment › should throw error for duplicate establishment name

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "DUPLICATE_ESTABLISHMENT",
        "statusCode": 409,
      }

      315 |       EstablishmentModel.checkDuplicateName.mockResolvedValue(true);
      316 |
    > 317 |       await expect(createEstablishment(partnerId, validEstablishmentData)).rejects.toMatchObject({
          |                                                                                    ^
      318 |         statusCode: 409,
      319 |         code: 'DUPLICATE_ESTABLISHMENT',
      320 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:317:84)

  ● establishmentService › createEstablishment › should handle database unique constraint violation

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "DUPLICATE_ESTABLISHMENT",
        "statusCode": 409,
      }

      330 |       EstablishmentModel.createEstablishment.mockRejectedValue(dbError);
      331 |
    > 332 |       await expect(createEstablishment(partnerId, validEstablishmentData)).rejects.toMatchObject({
          |                                                                                    ^
      333 |         statusCode: 409,
      334 |         code: 'DUPLICATE_ESTABLISHMENT',
      335 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:332:84)

  ● establishmentService › createEstablishment › should handle database check constraint violation

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "CONSTRAINT_VIOLATION",
        "statusCode": 422,
      }

      343 |       EstablishmentModel.createEstablishment.mockRejectedValue(dbError);
      344 |
    > 345 |       await expect(createEstablishment(partnerId, validEstablishmentData)).rejects.toMatchObject({
          |                                                                                    ^
      346 |         statusCode: 422,
      347 |         code: 'CONSTRAINT_VIOLATION',
      348 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:345:84)

  ● establishmentService › getPartnerEstablishments › should handle database errors gracefully

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "ESTABLISHMENTS_FETCH_FAILED",
        "statusCode": 500,
      }

      439 |       );
      440 |
    > 441 |       await expect(getPartnerEstablishments(partnerId)).rejects.toMatchObject({
          |                                                                 ^
      442 |         statusCode: 500,
      443 |         code: 'ESTABLISHMENTS_FETCH_FAILED',
      444 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:441:65)

  ● establishmentService › getEstablishmentById › should throw error when partner does not own establishment

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "ESTABLISHMENT_NOT_FOUND",
        "statusCode": 404,
      }

      471 |       EstablishmentModel.checkOwnership.mockResolvedValue(false);
      472 |
    > 473 |       await expect(getEstablishmentById(establishmentId, partnerId)).rejects.toMatchObject({
          |                                                                              ^
      474 |         statusCode: 404,
      475 |         code: 'ESTABLISHMENT_NOT_FOUND',
      476 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:473:78)

  ● establishmentService › getEstablishmentById › should throw error when establishment not found

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "ESTABLISHMENT_NOT_FOUND",
        "statusCode": 404,
      }

      483 |       EstablishmentModel.findEstablishmentById.mockResolvedValue(null);
      484 |
    > 485 |       await expect(getEstablishmentById(establishmentId, partnerId)).rejects.toMatchObject({
          |                                                                              ^
      486 |         statusCode: 404,
      487 |         code: 'ESTABLISHMENT_NOT_FOUND',
      488 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:485:78)

  ● establishmentService › getEstablishmentById › should handle database errors

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "ESTABLISHMENT_FETCH_FAILED",
        "statusCode": 500,
      }

      492 |       EstablishmentModel.checkOwnership.mockRejectedValue(new Error('Database error'));
      493 |
    > 494 |       await expect(getEstablishmentById(establishmentId, partnerId)).rejects.toMatchObject({
          |                                                                              ^
      495 |         statusCode: 500,
      496 |         code: 'ESTABLISHMENT_FETCH_FAILED',
      497 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:494:78)

  ● establishmentService › updateEstablishment › should throw error when partner does not own establishment

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "ESTABLISHMENT_NOT_FOUND",
        "statusCode": 404,
      }

      533 |       await expect(
      534 |         updateEstablishment(establishmentId, partnerId, { description: 'New' })
    > 535 |       ).rejects.toMatchObject({
          |                 ^
      536 |         statusCode: 404,
      537 |         code: 'ESTABLISHMENT_NOT_FOUND',
      538 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/establishmentService.test.js:535:17)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/integration/favorites.test.js
  ● Favorites System - Add to Favorites › should add establishment to favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Add to Favorites › should return establishment details in response

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Add to Favorites › should be idempotent (adding same favorite twice succeeds)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Add to Favorites › should reject favorite without authentication

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Add to Favorites › should reject favorite for non-existent establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Add to Favorites › should reject invalid establishment ID format

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Remove from Favorites › should remove establishment from favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Remove from Favorites › should be idempotent (removing non-existent favorite succeeds)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Remove from Favorites › should reject removal without authentication

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - List Favorites › should list all user favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - List Favorites › should include establishment details in list

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - List Favorites › should paginate favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - List Favorites › should return empty array for user with no favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - User Isolation › should only show own favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - User Isolation › should not allow removing other user favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Check Favorite Status › should return true for favorited establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Check Favorite Status › should return false for non-favorited establishment

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Batch Status Check › should check status for multiple establishments

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Batch Status Check › should handle empty array

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Batch Status Check › should handle non-existent establishments

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - CASCADE Deletion › should delete favorite when establishment is deleted

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Statistics › should return favorites count

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)

  ● Favorites System - Statistics › should return 0 for user with no favorites

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:32:16)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/favorites.test.js:82:3)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/integration/auth.test.js
  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should register new user with email successfully

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should register partner user with correct role

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should normalize email to lowercase

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should reject duplicate email

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should reject invalid email format

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should reject weak password

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should reject missing required fields

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Email Registration › should hash password with Argon2

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should register user with Belarus phone number

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should accept MTS operator (+37529)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should accept MTC operator (+37533)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should accept Velcom operator (+37544)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should reject non-Belarus phone number (Russia)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should reject non-Belarus phone number (USA)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should reject duplicate phone number

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Phone Registration › should reject registration without email or phone

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Edge Cases › should handle very long name

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Edge Cases › should handle name with special characters

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Registration › POST /api/v1/auth/register - Edge Cases › should trim whitespace from fields

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - Email Login › should login with valid email and password

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - Email Login › should reject invalid password

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - Email Login › should reject non-existent email

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - Email Login › should be case-insensitive for email

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - Phone Login › should login with valid phone and password

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - Phone Login › should reject invalid password for phone login

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - JWT Tokens › should generate valid JWT access token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - JWT Tokens › access token should expire in 15 minutes

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - User Login › POST /api/v1/auth/login - JWT Tokens › should generate cryptographically secure refresh token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Token Refresh › should refresh access token with valid refresh token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Token Refresh › should rotate refresh token (old token invalidated)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Token Refresh › should reject expired refresh token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Token Refresh › should reject used refresh token (replay attack prevention)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Token Refresh › should reject invalid refresh token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Logout › should invalidate refresh token on logout

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Logout › should still allow access with valid access token after logout

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Logout › should reject refresh token after logout

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Rate Limiting › should allow up to 5 failed login attempts

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Rate Limiting › should rate limit after 5 failed attempts

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Rate Limiting › should provide Retry-After header when rate limited

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Rate Limiting › should reset rate limit after timeout

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authentication Middleware › should authenticate valid JWT token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authentication Middleware › should reject missing Authorization header

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authentication Middleware › should reject malformed Authorization header

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authentication Middleware › should reject expired JWT token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authentication Middleware › should reject tampered JWT token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authorization › should allow user role access to user endpoints

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authorization › should allow partner role access to partner endpoints

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authorization › should allow admin role access to admin endpoints

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authorization › should reject user role accessing partner endpoints

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)

  ● Auth System - Authorization › should reject partner role accessing admin endpoints

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:24:3)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/auth.test.js:34:3)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/integration/search.test.js
  ● Search System - Radius-Based Search › should find establishments within 1km radius

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Radius-Based Search › should find establishments within 5km radius

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Radius-Based Search › should find establishments within 500km radius

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Radius-Based Search › should return empty array for search with no results

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Radius-Based Search › should include distance in response

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Radius-Based Search › should order results by distance (closest first)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Filtering › should filter by single category

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Filtering › should filter by multiple categories

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Filtering › should filter by single cuisine

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Filtering › should filter by price range

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Filtering › should combine multiple filters

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Filtering › should return empty for filter with no matches

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Pagination › should paginate results (page 1)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Pagination › should paginate results (page 2)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Pagination › should handle last page correctly

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Bounds-Based Search (Map View) › should search within geographic bounds

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Bounds-Based Search (Map View) › should exclude establishments outside bounds

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Validation › should reject missing latitude

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Validation › should reject invalid radius (negative)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Validation › should reject invalid coordinates (out of range)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Intelligent Ranking › should rank by combined distance + rating + review_count

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Intelligent Ranking › should prioritize establishments with boost_score

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Intelligent Ranking › should handle establishments with no reviews (NULL rating)

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Performance › should perform well with 1000+ establishments

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)

  ● Search System - Performance › should use PostGIS indexes efficiently

    connect ECONNREFUSED 127.0.0.1:5432

      68 |   ];
      69 |
    > 70 |   const result = await pool.query(query, values);
         |                  ^
      71 |   return result.rows[0];
      72 | }
      73 |

      at node_modules/pg-pool/index.js:45:11
      at createTestUser (src/tests/utils/auth.js:70:18)
      at createUserAndGetTokens (src/tests/utils/auth.js:81:16)
      at Object.<anonymous> (src/tests/integration/search.test.js:38:19)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at Object.<anonymous> (src/tests/integration/search.test.js:53:3)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/e2e/reviews-favorites-integration.test.js
  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 1: User discovers establishments through search

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 2: User adds establishments to favorites

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 3: User reviews first favorite (5 stars)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 4: User reviews second favorite (4 stars)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 5: User reviews third favorite (3 stars)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 6: Establishment metrics updated correctly

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 7: User updates their first review (changes rating)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 8: User deletes review for third establishment

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 9: User removes establishment from favorites

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Complete Integration Flow › STEP 10: User checks review quota

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Integration Data Consistency › Cannot review establishment not in favorites

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Integration Data Consistency › Deleting favorite does not delete review

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › Integration Data Consistency › Multiple users can review and favorite same establishment

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › User Isolation Verification › User cannot see other users favorites

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › User Isolation Verification › User cannot delete other users reviews

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)

  ● E2E Journey: Reviews & Favorites Integration › User Isolation Verification › User cannot update other users reviews

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:40:5)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/reviews-favorites-integration.test.js:76:5)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/unit/searchService.test.js
  searchService
    searchByRadius
      ✓ should search establishments with valid parameters (4 ms)
      ✕ should throw error for missing coordinates (5 ms)
      ✕ should validate latitude range (1 ms)
      ✕ should validate longitude range (2 ms)
      ✕ should validate radius range (2 ms)
      ✕ should validate limit range (2 ms)
      ✕ should validate offset range (1 ms)
      ✓ should filter by categories (1 ms)
      ✓ should filter by cuisines (6 ms)
      ✓ should filter by price range (1 ms)
      ✓ should filter by minimum rating (1 ms)
      ✓ should combine multiple filters (1 ms)
      ✓ should handle pagination correctly (1 ms)
      ✓ should calculate hasMore correctly (1 ms)
      ✓ should include distance in results (1 ms)
      ✓ should order results by distance, then rating, then review count (1 ms)
      ✓ should only search active establishments (2 ms)
    searchByBounds
      ✓ should search establishments within map bounds (1 ms)
      ✕ should validate bounds parameters (2 ms)
    checkSearchHealth
      ✕ should return healthy when PostGIS available (2 ms)
      ✓ should return unhealthy when PostGIS not available (1 ms)

  ● searchService › searchByRadius › should throw error for missing coordinates

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "MISSING_COORDINATES",
        "statusCode": 400,
      }

      79 |       await expect(
      80 |         searchByRadius({ latitude: 53.9, radius: 10 })
    > 81 |       ).rejects.toMatchObject({
         |                 ^
      82 |         statusCode: 400,
      83 |         code: 'MISSING_COORDINATES',
      84 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:81:17)

  ● searchService › searchByRadius › should validate latitude range

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_LATITUDE",
        "statusCode": 400,
      }

       96 |       await expect(
       97 |         searchByRadius({ ...validParams, latitude: -91 })
    >  98 |       ).rejects.toMatchObject({
          |                 ^
       99 |         statusCode: 400,
      100 |         code: 'INVALID_LATITUDE',
      101 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:98:17)

  ● searchService › searchByRadius › should validate longitude range

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_LONGITUDE",
        "statusCode": 400,
      }

      121 |       await expect(
      122 |         searchByRadius({ ...validParams, longitude: -181 })
    > 123 |       ).rejects.toMatchObject({
          |                 ^
      124 |         statusCode: 400,
      125 |         code: 'INVALID_LONGITUDE',
      126 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:123:17)

  ● searchService › searchByRadius › should validate radius range

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_RADIUS",
        "statusCode": 400,
      }

      139 |       await expect(
      140 |         searchByRadius({ ...validParams, radius: 0 })
    > 141 |       ).rejects.toMatchObject({
          |                 ^
      142 |         statusCode: 400,
      143 |         code: 'INVALID_RADIUS',
      144 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:141:17)

  ● searchService › searchByRadius › should validate limit range

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_LIMIT",
        "statusCode": 400,
      }

      165 |       await expect(
      166 |         searchByRadius({ ...validParams, limit: 0 })
    > 167 |       ).rejects.toMatchObject({
          |                 ^
      168 |         statusCode: 400,
      169 |         code: 'INVALID_LIMIT',
      170 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:167:17)

  ● searchService › searchByRadius › should validate offset range

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_OFFSET",
        "statusCode": 400,
      }

      182 |       await expect(
      183 |         searchByRadius({ ...validParams, offset: -1 })
    > 184 |       ).rejects.toMatchObject({
          |                 ^
      185 |         statusCode: 400,
      186 |         code: 'INVALID_OFFSET',
      187 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:184:17)

  ● searchService › searchByBounds › should validate bounds parameters

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_BOUNDS",
        "statusCode": 400,
      }

      399 |       await expect(
      400 |         searchByBounds({ minLat: 53.9, maxLat: 53.8, minLon: 27.4, maxLon: 27.6 })
    > 401 |       ).rejects.toMatchObject({
          |                 ^
      402 |         statusCode: 400,
      403 |         code: 'INVALID_BOUNDS',
      404 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/searchService.test.js:401:17)

  ● searchService › checkSearchHealth › should return healthy when PostGIS available

    expect(received).toBe(expected) // Object.is equality

    Expected: "3.1.1"
    Received: undefined

      423 |
      424 |       expect(result.healthy).toBe(true);
    > 425 |       expect(result.postgis_version).toBe('3.1.1');
          |                                      ^
      426 |
      427 |       expect(pool.query).toHaveBeenCalledWith('SELECT PostGIS_version() as postgis_version');
      428 |     });

      at Object.<anonymous> (src/tests/unit/searchService.test.js:425:38)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/unit/reviewService.test.js
  reviewService
    createReview
      ✓ should create review with valid data (4 ms)
      ✕ should throw error if user not found (4 ms)
      ✕ should throw error if user is inactive (6 ms)
      ✕ should throw error if establishment not found (2 ms)
      ✕ should enforce rate limit of 10 reviews per day (1 ms)
      ✓ should allow review when under rate limit (1 ms)
      ✕ should detect duplicate review (2 ms)
      ✕ should handle database unique constraint violation (2 ms)
      ✕ should handle foreign key violation (2 ms)
      ✕ should handle check constraint violation (2 ms)
      ✕ should update establishment aggregates synchronously (1 ms)
      ✓ should increment rate limit counter after successful creation (2 ms)
      ✓ should fetch complete review with author information (1 ms)
    updateReview
      ✕ should update review when user owns it (3 ms)
      ✕ should throw error when review not found (6 ms)
      ✕ should throw error when user does not own review (2 ms)
      ✓ should update aggregates when rating changes (1 ms)
    deleteReview
      ✕ should soft delete review when user owns it (2 ms)
      ✕ should throw error when user does not own review (2 ms)
    getReviewsByEstablishment
      ✕ should fetch reviews with pagination (1 ms)
      ✕ should enforce maximum limit

  ● reviewService › createReview › should throw error if user not found

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "USER_NOT_FOUND",
        "statusCode": 404,
      }

      118 |       ReviewModel.getUserById.mockResolvedValue(null);
      119 |
    > 120 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      121 |         statusCode: 404,
      122 |         code: 'USER_NOT_FOUND',
      123 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:120:59)

  ● reviewService › createReview › should throw error if user is inactive

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "USER_INACTIVE",
        "statusCode": 403,
      }

      133 |       });
      134 |
    > 135 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      136 |         statusCode: 403,
      137 |         code: 'USER_INACTIVE',
      138 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:135:59)

  ● reviewService › createReview › should throw error if establishment not found

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "ESTABLISHMENT_NOT_FOUND",
        "statusCode": 404,
      }

      144 |       ReviewModel.establishmentExists.mockResolvedValue(false);
      145 |
    > 146 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      147 |         statusCode: 404,
      148 |         code: 'ESTABLISHMENT_NOT_FOUND',
      149 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:146:59)

  ● reviewService › createReview › should enforce rate limit of 10 reviews per day

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "RATE_LIMIT_EXCEEDED",
        "statusCode": 429,
      }

      155 |       getCounter.mockResolvedValue(10); // Already at limit
      156 |
    > 157 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      158 |         statusCode: 429,
      159 |         code: 'RATE_LIMIT_EXCEEDED',
      160 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:157:59)

  ● reviewService › createReview › should detect duplicate review

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "DUPLICATE_REVIEW",
        "statusCode": 409,
      }

      179 |       ReviewModel.findExistingReview.mockResolvedValue(mockReview);
      180 |
    > 181 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      182 |         statusCode: 409,
      183 |         code: 'DUPLICATE_REVIEW',
      184 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:181:59)

  ● reviewService › createReview › should handle database unique constraint violation

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "DUPLICATE_REVIEW",
        "statusCode": 409,
      }

      192 |       ReviewModel.createReview.mockRejectedValue(error);
      193 |
    > 194 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      195 |         statusCode: 409,
      196 |         code: 'DUPLICATE_REVIEW',
      197 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:194:59)

  ● reviewService › createReview › should handle foreign key violation

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "INVALID_REFERENCE",
        "statusCode": 400,
      }

      203 |       ReviewModel.createReview.mockRejectedValue(error);
      204 |
    > 205 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      206 |         statusCode: 400,
      207 |         code: 'INVALID_REFERENCE',
      208 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:205:59)

  ● reviewService › createReview › should handle check constraint violation

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "CONSTRAINT_VIOLATION",
        "statusCode": 400,
      }

      214 |       ReviewModel.createReview.mockRejectedValue(error);
      215 |
    > 216 |       await expect(createReview(validReviewData)).rejects.toMatchObject({
          |                                                           ^
      217 |         statusCode: 400,
      218 |         code: 'CONSTRAINT_VIOLATION',
      219 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:216:59)

  ● reviewService › createReview › should update establishment aggregates synchronously

    TypeError: expect(...).toHaveBeenCalledBefore is not a function

      225 |       // Verify aggregates updated before completion
      226 |       expect(ReviewModel.updateEstablishmentAggregates).toHaveBeenCalledWith('estab-123');
    > 227 |       expect(ReviewModel.updateEstablishmentAggregates).toHaveBeenCalledBefore(
          |                                                         ^
      228 |         ReviewModel.findReviewById
      229 |       );
      230 |     });

      at Object.<anonymous> (src/tests/unit/reviewService.test.js:227:57)

  ● reviewService › updateReview › should update review when user owns it

    expect(received).toMatchObject(expected)

    - Expected  - 2
    + Received  + 2

      Object {
    -   "content": "Updated review content",
    -   "rating": 4,
    +   "content": "Original content",
    +   "rating": 5,
      }

      279 |       const result = await updateReview(reviewId, userId, updates);
      280 |
    > 281 |       expect(result).toMatchObject(updates);
          |                      ^
      282 |       expect(ReviewModel.updateReview).toHaveBeenCalledWith(reviewId, updates);
      283 |
      284 |       // Verify aggregates updated

      at Object.<anonymous> (src/tests/unit/reviewService.test.js:281:22)

  ● reviewService › updateReview › should throw error when review not found

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "REVIEW_NOT_FOUND",
        "statusCode": 404,
      }

      291 |       ReviewModel.findReviewById.mockResolvedValue(null);
      292 |
    > 293 |       await expect(updateReview(reviewId, userId, updates)).rejects.toMatchObject({
          |                                                                     ^
      294 |         statusCode: 404,
      295 |         code: 'REVIEW_NOT_FOUND',
      296 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:293:69)

  ● reviewService › updateReview › should throw error when user does not own review

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "FORBIDDEN",
        "statusCode": 403,
      }

      300 |
      301 |     test('should throw error when user does not own review', async () => {
    > 302 |       await expect(updateReview(reviewId, 'different-user', updates)).rejects.toMatchObject({
          |                                                                               ^
      303 |         statusCode: 403,
      304 |         code: 'FORBIDDEN',
      305 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:302:79)

  ● reviewService › deleteReview › should soft delete review when user owns it

    Review not found or already deleted

      462 |     
      463 |     if (!deleted) {
    > 464 |       throw new AppError('Review not found or already deleted', 404, 'REVIEW_NOT_FOUND');
          |             ^
      465 |     }
      466 |
      467 |     // Update establishment aggregate statistics synchronously

      at deleteReview (src/services/reviewService.js:464:13)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:329:7)

  ● reviewService › deleteReview › should throw error when user does not own review

    expect(received).rejects.toMatchObject(expected)

    - Expected  - 1
    + Received  + 0

      Object {
    -   "code": "FORBIDDEN",
        "statusCode": 403,
      }

      338 |
      339 |     test('should throw error when user does not own review', async () => {
    > 340 |       await expect(deleteReview(reviewId, 'different-user')).rejects.toMatchObject({
          |                                                                      ^
      341 |         statusCode: 403,
      342 |         code: 'FORBIDDEN',
      343 |       });

      at Object.toMatchObject (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/tests/unit/reviewService.test.js:340:70)

  ● reviewService › getReviewsByEstablishment › should fetch reviews with pagination

    TypeError: getReviewsByEstablishment is not a function

      356 |       ReviewModel.countReviewsByEstablishment.mockResolvedValue(15);
      357 |
    > 358 |       const result = await getReviewsByEstablishment(establishmentId, {
          |                            ^
      359 |         page: 1,
      360 |         limit: 10,
      361 |       });

      at Object.<anonymous> (src/tests/unit/reviewService.test.js:358:28)

  ● reviewService › getReviewsByEstablishment › should enforce maximum limit

    TypeError: getReviewsByEstablishment is not a function

      374 |       ReviewModel.countReviewsByEstablishment.mockResolvedValue(0);
      375 |
    > 376 |       await getReviewsByEstablishment(establishmentId, { limit: 200 });
          |             ^
      377 |
      378 |       expect(ReviewModel.getReviewsByEstablishment).toHaveBeenCalledWith(
      379 |         establishmentId,

      at Object.<anonymous> (src/tests/unit/reviewService.test.js:376:13)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/e2e/search-discovery-journey.test.js
  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 1: User searches near Minsk center (wide radius)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 2: User filters by category (Кофейня)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 3: User filters by cuisine (Народная)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 4: User filters by price range ($)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 5: User combines multiple filters

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 6: User uses map view (bounds-based search)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 7: User narrows search radius

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Complete Search & Discovery Journey › STEP 8: User searches with pagination

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Search Edge Cases › Search with invalid coordinates fails gracefully

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Search Edge Cases › Search with zero radius fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Search Edge Cases › Search with very large radius limited

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › Search Edge Cases › Search without coordinates fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › PostGIS Integration Verification › Distance calculations are accurate

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)

  ● E2E Journey: Search & Discovery Complete Flow › PostGIS Integration Verification › Results ordered correctly by distance

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:34:5)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/search-discovery-journey.test.js:110:5)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/e2e/partner-journey.test.js
  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 1: Partner registers with partner role

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 2: Partner creates new establishment in draft status

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 3: Partner updates establishment with more details

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 4: Partner submits establishment for moderation

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 5: Partner can view their establishment list

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 6: Admin approves establishment (simulated)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 7: Customer leaves review on establishment

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Complete Partner Journey › STEP 8: Partner sees their establishment details with reviews

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Partner Workflow Edge Cases › Partner cannot edit another partner's establishment

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Partner Workflow Edge Cases › Regular user cannot create establishment

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Partner Workflow Edge Cases › Partner cannot submit establishment without required fields

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Partner Workflow Edge Cases › Partner can list only their own establishments

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)

  ● E2E Journey: Partner Establishment Management › Status Transition Workflow › Establishment follows correct status progression

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:37:5)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/partner-journey.test.js:41:5)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/unit/jwt.test.js
  jwt utilities
    generateAccessToken
      ✓ should generate valid JWT access token (15 ms)
      ✓ should include correct claims in token (2 ms)
      ✓ should include expiration claim (1 ms)
      ✕ should generate different tokens for same payload at different times (3 ms)
    generateRefreshToken
      ✓ should generate 64-character hex string (2 ms)
      ✓ should generate unique tokens (1 ms)
      ✓ should be cryptographically random (1 ms)
    verifyAccessToken
      ✓ should verify valid token (2 ms)
      ✓ should throw error for invalid token (9 ms)
      ✓ should throw error for token with wrong signature (2 ms)
      ✓ should throw error for expired token (2 ms)
      ✓ should throw error for non-access token type (2 ms)
      ✓ should throw error for token with wrong issuer (2 ms)
      ✓ should throw error for token with wrong audience (2 ms)
    extractTokenFromHeader
      ✓ should extract token from valid Bearer header (1 ms)
      ✓ should return null for missing header (1 ms)
      ✓ should return null for malformed header (no Bearer prefix) (1 ms)
      ✓ should handle token with spaces correctly (1 ms)
      ✓ should extract JWT format tokens (1 ms)
      ✓ should handle case-sensitive Bearer prefix
    getRefreshTokenExpiry
      ✓ should return date 30 days in future (1 ms)
      ✓ should return different timestamps when called multiple times (12 ms)
      ✓ should return valid Date object (1 ms)
    Token Security
      ✓ access tokens should not be modifiable without detection (3 ms)
      ✓ tokens should include all required security claims (1 ms)

  ● jwt utilities › generateAccessToken › should generate different tokens for same payload at different times

    expect(received).not.toBe(expected) // Object.is equality

    Expected: not "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ1c2VyLTEyMyIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJ1c2VyIiwidHlwZSI6ImFjY2VzcyIsImlhdCI6MTc2Mjc3NzM0NywiZXhwIjoxNzYyNzc4MjQ3LCJhdWQiOiJyZXN0YXVyYW50LWd1aWRlLWFwaSIsImlzcyI6InJlc3RhdXJhbnQtZ3VpZGUtYmVsYXJ1cyJ9.yOk3VU679O2OeaISsuxtEBGP1_v_OxVcaa7zQQ_lqjM"

      85 |
      86 |       return token2.then(t2 => {
    > 87 |         expect(t2).not.toBe(token1);
         |                        ^
      88 |       });
      89 |     });
      90 |   });

      at src/tests/unit/jwt.test.js:87:24

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/e2e/auth-journey.test.js
  ● E2E Journey: Authentication Complete Flow › Complete Authentication Lifecycle › STEP 1: User registers new account

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Complete Authentication Lifecycle › STEP 2: User can access protected endpoint with token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Complete Authentication Lifecycle › STEP 3: User logs out (invalidates refresh token)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Complete Authentication Lifecycle › STEP 4: User logs back in with credentials

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Complete Authentication Lifecycle › STEP 5: User refreshes access token

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Complete Authentication Lifecycle › STEP 6: User can login with phone instead of email

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Registration with weak password fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Registration with duplicate email fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Registration with non-Belarus phone fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Login with wrong password fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Login with non-existent email fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Access protected endpoint without token fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Access protected endpoint with invalid token fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Authentication Security Verification › Refresh with invalid token fails

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Email and Phone Normalization › Email is normalized to lowercase

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Email and Phone Normalization › Phone number is normalized (spaces removed)

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)

  ● E2E Journey: Authentication Complete Flow › Email and Phone Normalization › Can login with email in different case

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:36:5)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/auth-journey.test.js:40:5)

  console.log
    ✅ Test environment variables loaded from .env.test

      at src/tests/setup-env.js:26:9

FAIL src/tests/e2e/new-user-journey.test.js
  ● E2E Journey: New User Complete Flow › Complete User Journey › STEP 1: New user registers successfully

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Complete User Journey › STEP 2: User searches for restaurants near Minsk center

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Complete User Journey › STEP 3: User adds interesting restaurant to favorites

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Complete User Journey › STEP 4: User visits restaurant and leaves a positive review

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Complete User Journey › STEP 5: User checks their favorites list

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Complete User Journey › INTEGRATION: Verify complete user state after journey

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Edge Cases in User Journey › User cannot add same establishment to favorites twice

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Edge Cases in User Journey › User cannot leave second review for same establishment

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)

  ● E2E Journey: New User Complete Flow › Edge Cases in User Journey › User cannot review without being authenticated

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:36:5)


  ● Test suite failed to run

    connect ECONNREFUSED 127.0.0.1:5432

      24 |   try {
      25 |     // Disable triggers temporarily for faster truncation
    > 26 |     await pool.query('SET session_replication_role = replica;');
         |     ^
      27 |
      28 |     // Truncate all tables in correct order (respecting foreign keys)
      29 |     await pool.query('TRUNCATE TABLE establishment_media CASCADE');

      at node_modules/pg-pool/index.js:45:11
      at clearAllData (src/tests/utils/database.js:26:5)
      at cleanDatabase (src/tests/e2e/helpers.js:148:3)
      at Object.<anonymous> (src/tests/e2e/new-user-journey.test.js:56:5)

Test Suites: 16 failed, 16 total
Tests:       255 failed, 43 todo, 53 passed, 351 total
Snapshots:   0 total
Time:        17.839 s
Ran all test suites.


════════════════════════════════════════════════════════════

🧹 Cleaning up test environment...

✅ Database connections closed
✅ Test environment cleaned up

════════════════════════════════════════════════════════════


